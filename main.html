<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Information retention of content on social media</title>
    
    <!-- jsPsych CSS -->
    <link href="https://unpkg.com/jspsych@8.2.1/css/jspsych.css" rel="stylesheet" />
    <!-- jsPsych core and plugins -->
    <script src="https://unpkg.com/jspsych@8.2.1"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-multi-choice@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-likert@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-text@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey@2.1.0"></script>
    
    <!-- Papaparse to load the csv with posts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    
    <!-- Instagram embed script -->
    <script async src="//www.instagram.com/embed.js"></script>
    
    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
            text-align: center;
            margin: 0;
        }
        .wrapper {
            max-width: 600px;
            text-align: center;
            margin: 0 auto;
            
        }
        .jspsych-content {
            width: 600px;
            text-align: left;
        }
        .centering {
            text-align: center;
            margin: auto;
            max-width: 470px;
        }
        .group-prediction-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .group-prediction-item {
            width: 48%;
        }
    </style>
</head>
<body>
    <div class="wrapper">
        <div id="jspsych-target"></div>
    </div>
    
    <script type="module">
        
        // Initialize Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-analytics.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
        const firebaseConfig = {
            apiKey: "AIzaSyAShFvRQZGFNY_PWwAL5X2PiAV-AlZyEJ4",
            authDomain: "phd-bristol.firebaseapp.com",
            projectId: "phd-bristol",
            storageBucket: "phd-bristol.firebasestorage.app",
            messagingSenderId: "559795586505",
            appId: "1:559795586505:web:329eaebd889be645285418",
            measurementId: "G-5CJBSCB2WH"
        };
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);
        
        // Collect Prolific ID
        const urlParams = new URLSearchParams(window.location.search);
        const prolificID = urlParams.get('PROLIFIC_PID') || 'unknown';
        
        // Time limit for scrolling through the feed
        const treatmentTime = 3 * 60 * 1000; // 3 minutes
        
        // Load all posts from csv
        let allPosts = [];
        let controlPosts = [];
        let treatment1Posts = [];
        let treatment2Posts = [];
        function createInstagramBlockquote(link) {
            return `<blockquote class="instagram-media" data-instgrm-captioned data-instgrm-permalink="${link}" data-instgrm-version="14" style="background:#FFF; border:0; margin:1px; max-width:470px; min-width:326px; padding:0; width:99.375%;"></blockquote><br/><br/>`;
        }
        Papa.parse('posts.csv', {
            download: true,
            header: true,
            complete: function(results) {
                results.data.forEach(row => {
                    let blockquoteHTML = createInstagramBlockquote(row.link);
                    if (row.group === 'all') {
                        allPosts.push(blockquoteHTML);
                    } else if (row.group === 'control') {
                        controlPosts.push(blockquoteHTML);
                    } else if (row.group === 'treatment1') {
                        treatment1Posts.push(blockquoteHTML);
                    } else if (row.group === 'treatment2') {
                        treatment2Posts.push(blockquoteHTML);
                    }
                });
                
                // Now combine 'all' posts + specific posts (no duplicates)
                const controlGroup = allPosts.concat(controlPosts);
                const treatment1Group = allPosts.concat(treatment1Posts);
                const treatment2Group = allPosts.concat(treatment2Posts);
                function shuffle(array) {
                    for (let i = array.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [array[i], array[j]] = [array[j], array[i]]; // swap
                    }
                }
                shuffle(controlGroup);
                shuffle(treatment1Group);
                shuffle(treatment2Group);
                
                // Initialize jsPsych instance
                const jsPsych = initJsPsych({
                    display_element: 'jspsych-target',
                    on_finish: function() {
                        const data = jsPsych.data.get().json();
                        let parsedData = JSON.parse(data);
                        // Remove 'stimulus' from each trial object
                        parsedData.forEach(trial => {
                            delete trial.stimulus;
                        });
                        addDoc(collection(db, "experimentData"), {
                            prolific_id: prolificID,
                            timestamp: serverTimestamp(),
                            data: parsedData,
                        })
                        .then(() => {
                            console.log("Data successfully written!");
                            document.getElementById('jspsych-target').innerHTML = "<p>Thank you! You may return to Prolific.</p>";
                        })
                        .catch((error) => {
                            console.error("Error writing to Firestore: ", error);
                            document.getElementById('jspsych-target').innerHTML = "<p>Error saving data. Please contact the researcher.</p>";
                        });
                    }
                });
                
                // Set up control vs treatments (prevent to generate new group from same browser/day)
                const CONDITION_KEY = 'assigned_condition';
                const CONDITION_DATE_KEY = 'condition_date';
                // Get today's date as string, e.g., '2025-06-12'
                function getTodayDateString() {
                    return new Date().toISOString().slice(0, 10);
                }
                // Control which condition the participant is assigned to
                function getAssignedCondition() {
                    const storedDate = localStorage.getItem(CONDITION_DATE_KEY);
                    const today = getTodayDateString();
                    
                    if (storedDate === today) {
                        // Same day — return stored condition
                        return localStorage.getItem(CONDITION_KEY);
                        // TO DO : store information about user reloading the page
                    } else {
                        // Different day or no stored data — assign new condition
                        const conditions = ['control', 'treatment1', 'treatment2'];
                        const assigned_condition = jsPsych.randomization.sampleWithoutReplacement(conditions, 1)[0];
                        // Store it
                        localStorage.setItem(CONDITION_KEY, assigned_condition);
                        localStorage.setItem(CONDITION_DATE_KEY, today);
                        return assigned_condition;
                    }
                }
                const assigned_condition = getAssignedCondition();
                console.log('Assigned condition:', assigned_condition);
                
                // Timeline definition
                const timeline = [];
                
                // Step 0 - Consent
                
                // Step 1 - Intro
                const intro = {
                    type: jsPsychHtmlButtonResponse,
                    stimulus: `<h2>Information retention of content on social media</h2>
                <p>This study investigates how people process different types of communication online. You’ll have up to 3 minutes to scroll through a selection of posts from random topics (health, technology, environment, entertainement, etc.) and then answer a series of questions about your impressions, memory, and opinions.</p>
                <p>We are also testing whether people can predict other participants are answering some of the same questions. The 5 participants who make the most accurate guesses will win an additional £20.</p>
                <p>You will have up to 3 minutes to scroll through the posts, and then complete a questionnaire afterwards. Below you should see one post as an example, make sure your browser is rendering the content. You might have to change your browser settings.</p>
                <br/><div class="centering">
                <blockquote class="instagram-media" data-instgrm-permalink="https://www.instagram.com/p/DKff6O5N8Ym/" data-instgrm-version="14" style="background:#FFF; border:0; margin:1px; max-width:470px; min-width:326px; padding:0; width:99.375%;"></blockquote>
                </div>`,
                    choices: ['Start'],
                    prompt: "<p>Click the button above when you're ready to begin.</p>",
                    on_load: () => {
                        // After stimulus is inserted, process Instagram embeds
                        if (window.instgrm && window.instgrm.Embeds) {
                            window.instgrm.Embeds.process();
                        }
                    }
                };
                timeline.push(intro);        
                
                // Step 2 - Treatment
                const control_trials = {
                    type: jsPsychHtmlButtonResponse,
                    stimulus: `<h2>Instagram posts</h2>
                    <p>You will have up to 3 minutes to scroll through the videos, and then complete a questionnaire afterwards.</p>
                    <div class="centering">`
                    + controlGroup.join('')
                    + `</div>`,
                    choices: ['Next'],
                    trial_duration: treatmentTime,
                    on_load: () => {
                        // After stimulus is inserted, process Instagram embeds
                        if (window.instgrm && window.instgrm.Embeds) {
                            window.instgrm.Embeds.process();
                        }
                    }
                };
                const treatment1_trials = {
                    type: jsPsychHtmlButtonResponse,
                    stimulus: `<h2>Instagram posts</h2>
                    <p>You will have up to 3 minutes to scroll through the videos, and then complete a questionnaire afterwards.</p>
                    <div class="centering">`
                    + treatment1Group.join('')
                    + `</div>`,
                    choices: ['Next'],
                    trial_duration: treatmentTime,
                    on_load: () => {
                        // After stimulus is inserted, process Instagram embeds
                        if (window.instgrm && window.instgrm.Embeds) {
                            window.instgrm.Embeds.process();
                        }
                    }
                };
                const treatment2_trials = {
                    type: jsPsychHtmlButtonResponse,
                    stimulus: `<h2>Instagram posts</h2>
                    <p>You will have up to 3 minutes to scroll through the videos, and then complete a questionnaire afterwards.</p>
                    <div class="centering">`
                    + treatment2Group.join('')
                    + `</div>`,
                    choices: ['Next'],
                    trial_duration: treatmentTime,
                    on_load: () => {
                        // After stimulus is inserted, process Instagram embeds
                        if (window.instgrm && window.instgrm.Embeds) {
                            window.instgrm.Embeds.process();
                        }
                    }
                };
                // Save condition
                timeline.forEach(trial => {
                    trial.data = { condition: assigned_condition };
                });
                // Only push the randomly selected group
                if (assigned_condition === 'control') {
                    timeline.push(control_trials);
                } else if (assigned_condition === 'treatment1') {
                    timeline.push(treatment1_trials);
                } else if (assigned_condition === 'treatment2') {
                    timeline.push(treatment2_trials);
                }
                
                const memory_check = {
                    type: jsPsychSurveyHtmlForm,
                    preamble: "<h2>Memory & Media Check</h2><p>Please answer the following questions as best as you can.</p>",
                    html: `
                    <div>
                    <p><strong>Please list the names of all people mentioned in these posts.</strong></p>
                    <textarea name="names" rows="2" cols="50"></textarea><br><br>

                    <p><strong>The two main topics randomly assigned to you were health and environment. How many posts related to health did you see?</strong></p>
                    <input type="number" name="health_count"><br><br>

                    <p><strong>How often do you see environmental content like this on social media or elsewhere?</strong></p>
                    <label><input type="radio" name="env_frequency" value="never" required> Never</label><br>
                    <label><input type="radio" name="env_frequency" value="rarely"> Rarely</label><br>
                    <label><input type="radio" name="env_frequency" value="sometimes"> Once in a while</label><br>
                    <label><input type="radio" name="env_frequency" value="daily"> Every day or so</label><br>
                    <label><input type="radio" name="env_frequency" value="all_time"> All of the time</label><br>

                    <p><strong>Which sources do you see content of any type most often? (Select all that apply)</strong></p>
                    <label><input type="checkbox" name="sources" value="bbc"> BBC</label><br>
                    <label><input type="checkbox" name="sources" value="guardian"> Guardian</label><br>
                    <label><input type="checkbox" name="sources" value="sky"> Sky News</label><br>
                    <label><input type="checkbox" name="sources" value="independent"> The Independent</label><br>
                    <label><input type="checkbox" name="sources" value="channelfour"> Channel 4</label><br>
                    <label><input type="checkbox" name="sources" value="unilad"> UNILAD/LADbible</label><br>
                    <label><input type="checkbox" name="sources" value="other"> Other</label><br>
                    <label><input type="checkbox" name="sources" value="none"> None</label><br><br>
                    </div>
                    `,
                    button_label: "Continue"
                };
                
                timeline.push(memory_check);
                
                
                
                // Step 4 - Questionnaire survey    
                const survey_questions = [
                {
                    prompt: "Limiting the amount of meat and dairy products people can buy per week",
                    name: "meat_dairy_limit",
                    labels: ["Disagree", "Neutral", "Agree"],
                    required: true
                },
                {
                    prompt: "Increase the Fuel Duty tax, the tax drivers pay on fuel",
                    name: "fuel_tax",
                    labels: ["Disagree", "Neutral", "Agree"],
                    required: true
                },
                {
                    prompt: "Blanket tax on all air fares, increasing the prices of flights by 50%",
                    name: "flight_tax",
                    labels: ["Disagree", "Neutral", "Agree"],
                    required: true
                },
                {
                    prompt: "Banning all single-use plastic",
                    name: "plastic_ban",
                    labels: ["Disagree", "Neutral", "Agree"],
                    required: true
                },
                {
                    prompt: "Wealthy countries should take on most of the responsibility of tackling climate change",
                    name: "rich_country_responsibility",
                    labels: ["Disagree", "Neutral", "Agree"],
                    required: true
                },
                {
                    prompt: "News organizations should be legally required to present multiple sides of controversial issues",
                    name: "news_balance",
                    labels: ["Disagree", "Neutral", "Agree"],
                    required: true
                },
                {
                    prompt: "Deepfake videos will become a serious threat to political stability in the next decade",
                    name: "deepfake_threat",
                    labels: ["Disagree", "Neutral", "Agree"],
                    required: true
                },
                {
                    prompt: "Social media platforms should be required to label all AI-generated content",
                    name: "ai_labeling",
                    labels: ["Disagree", "Neutral", "Agree"],
                    required: true
                },
                {
                    prompt: "Universal Basic Income (UBI) should be introduced to address job losses from automation",
                    name: "ubi_automation",
                    labels: ["Disagree", "Neutral", "Agree"],
                    required: true
                },
                {
                    prompt: "Governments should regulate the sale of highly processed foods to reduce obesity",
                    name: "food_regulation",
                    labels: ["Disagree", "Neutral", "Agree"],
                    required: true
                },
                {
                    prompt: "Mandatory mental health screenings should be introduced in schools and workplaces",
                    name: "mental_health_screening",
                    labels: ["Disagree", "Neutral", "Agree"],
                    required: true
                }
                ];
                // Randomize question order
                const randomized_questions = jsPsych.randomization.shuffle(survey_questions);
                const survey = {
                    type: jsPsychSurveyLikert,
                    questions: randomized_questions,
                    preamble: "<p>Please indicate your opinion on the following statements:</p>",
                    scale_width: 500, // Optional: control the width of the Likert scale
                    button_label: "Submit"
                };
                timeline.push(survey);
                
                // Step 5 - Guessing how many % of others agreed
                const prediction_questions_groups = randomized_questions.map((question, index) => {
                    return {
                        prompt: `---<br><br><em>"${question.prompt}"</em><br>
                <div class="group-prediction-container">
                <div class="group-prediction-item">
                <label>Ingroup participants (%):</label><br>
                <input type="text" name="prediction_ingroup_${index}" placeholder="0-100" required pattern="^([0-9]{1,2}(\\.[0-9]+)?|100(\\.0+)?)$">
                </div>
                <div class="group-prediction-item">
                <label>Outgroup participants (%):</label><br>
                <input type="text" name="prediction_outgroup_${index}" placeholder="0-100" required pattern="^([0-9]{1,2}(\\.[0-9]+)?|100(\\.0+)?)$">
                </div>
                </div>`,
                        required: false // HTML itself handles required via input
                    };
                });
                const prediction_survey_groups = {
                    type: jsPsychSurveyHtmlForm,
                    preamble: `<p>Estimate the percentage of <strong>Ingroup and Outgroup participants</strong> who selected "Agree" for each of those previous statements. All participants in this study are aged 18-25 and live in the U.K.</p>
                    <p>Enter a number between 0 and 100 for each group, where 0 means none and 100 means all of them. For example, if you think half of the Ingroup agreed, enter "50" for Ingroup. The 5 participants who make the most accurate guesses will win an additional £20.</p>`,
                    html: prediction_questions_groups.map(q => q.prompt).join(''),
                    button_label: "Submit Predictions",
                    on_finish: function(data) {
                        const responses = data.response;  // responses from the form inputs as an object
                        // Validate all values:
                        for (const key in responses) {
                            const num = Number(responses[key]);
                            if (isNaN(num) || num < 0 || num > 100) {
                                alert(`Please enter valid numbers between 0 and 100 for all fields.`);
                                jsPsych.pauseExperiment();
                                return;
                            }
                            responses[key] = num;
                        }
                        // data.group_predictions = responses;
                    }
                };
                timeline.push(prediction_survey_groups);
                
                // Step 6 - Outro
                const outro = {
                    type: jsPsychHtmlButtonResponse,
                    stimulus: "<p>Final test screen. Click to finish.</p>",
                    choices: ["Finish"]
                };
                timeline.push(outro);
                
                jsPsych.run(timeline);
            }
        });  
        
    </script>
</body>
</html>
